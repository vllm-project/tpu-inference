ARG NIGHTLY_DATE="20250714"
ARG BASE_IMAGE="us-central1-docker.pkg.dev/tpu-pytorch-releases/docker/xla:nightly_3.12_tpuvm_$NIGHTLY_DATE"

FROM $BASE_IMAGE

# Remove existing versions of dependencies
RUN pip uninstall -y torch torch_xla torchvision

# Install some basic utilities
RUN apt-get update && apt-get install -y \
    git \
    libopenblas-base libopenmpi-dev libomp-dev

# Install tpu_inference
WORKDIR /workspace/tpu_inference
COPY . .
RUN export TARGET_TAG=$(git tag -l "v*" --sort=-v:refname | grep -E "^v[0-9]+\.[0-9]+\.[0-9]+$" | head -n 1) && \
    echo "Found tpu_inference tag: $TARGET_TAG" && \
    git checkout "$TARGET_TAG" && \
    echo -n "$TARGET_TAG" > /tmp/target_version

# Clone vLLM
WORKDIR /workspace/vllm
ARG VLLM_REPO=https://github.com/vllm-project/vllm.git
RUN git clone $VLLM_REPO /workspace/vllm
RUN export TARGET_TAG=$(cat /tmp/target_version) && \
    echo "Syncing vLLM to match tpu_inference tag: $TARGET_TAG" && \
    git checkout "$TARGET_TAG"

# Install vllm-tpu from PyPI
RUN export TARGET_TAG=$(cat /tmp/target_version) && \
    export PIP_VERSION=$(echo "$TARGET_TAG" | sed 's/^v//') && \
    echo "Installing vllm-tpu version: $PIP_VERSION" && \
    python3 -m pip install -v --no-cache-dir "vllm-tpu==$PIP_VERSION"

# Install test dependencies
RUN python3 -m pip install -e tests/vllm_test_utils
RUN python3 -m pip install --no-cache-dir \
    git+https://github.com/thuml/depyf.git \
    pytest-asyncio \
    git+https://github.com/EleutherAI/lm-evaluation-harness.git@206b7722158f58c35b7ffcd53b035fdbdda5126d#egg=lm-eval[api] \
    pytest-cov \
    tblib

CMD ["/bin/bash"]
