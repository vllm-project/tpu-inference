ARG NIGHTLY_DATE="20250714"
ARG BASE_IMAGE="us-central1-docker.pkg.dev/tpu-pytorch-releases/docker/xla:nightly_3.12_tpuvm_$NIGHTLY_DATE"

FROM $BASE_IMAGE

# Remove existing versions of dependencies
RUN pip uninstall -y torch torch_xla torchvision

# Install some basic utilities
RUN apt-get update && apt-get install -y \
    git \
    libopenblas-base libopenmpi-dev libomp-dev

# Clone vLLM
WORKDIR /workspace/vllm
ARG VLLM_REPO=https://github.com/vllm-project/vllm.git
RUN git clone $VLLM_REPO /workspace/vllm
RUN pip install -r requirements/tpu.txt --retries 3
#RUN pip install -r requirements/common.txt --retries 3
#RUN pip install -r requirements/test.txt --retries 3

# Install vllm-tpu from PyPI
RUN python3 -m pip install -v --no-cache-dir vllm-tpu

# Install test dependencies
RUN python3 -m pip install -e tests/vllm_test_utils
RUN python3 -m pip install --no-cache-dir \
    git+https://github.com/thuml/depyf.git \
    pytest-asyncio \
    git+https://github.com/EleutherAI/lm-evaluation-harness.git@206b7722158f58c35b7ffcd53b035fdbdda5126d#egg=lm-eval[api] \
    pytest-cov \
    tblib

# Install tpu_inference
WORKDIR /workspace/tpu_inference  
# These are needed for the E2E benchmarking tests (i.e. tests/e2e/benchmarking/mlperf.sh) 
COPY requirements_benchmarking.txt .
RUN pip install -r requirements_benchmarking.txt --retries 3
COPY . . 

CMD ["/bin/bash"]
