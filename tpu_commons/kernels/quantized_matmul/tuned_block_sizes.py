# SPDX-License-Identifier: Apache-2.0
import re

import jax

from tpu_commons.logger import init_logger

logger = init_logger(__name__)

# Below are tuned block sizes.

# key:
#    - tpu_version
#    - batch_size
#    - n_output_features
#    - n_input_features
#    - weight_dtype
#    - quantize_activation
# value:
#    - batch_block_size
#    - out_block_size
#    - in_block_size
TUNED_BLOCK_SIZES = {
    # go/keep-sorted start
    (6, 1024, 1024, 4096, 'int8', True): (1024, 256, 4096),
    (6, 1024, 1024, 8192, 'int8', True): (1024, 256, 8192),
    (6, 1024, 128, 8192, 'int8', True): (512, 128, 8192),
    (6, 1024, 1280, 8192, 'int8', True): (1024, 256, 8192),
    (6, 1024, 13824, 5120, 'int8', True): (1024, 1536, 5120),
    (6, 1024, 14336, 4096, 'int8', True): (1024, 1024, 4096),
    (6, 1024, 1792, 5120, 'int8', True): (1024, 256, 5120),
    (6, 1024, 28672, 4096, 'int8', True): (1024, 1792, 4096),
    (6, 1024, 3584, 18944, 'int8', True): (512, 512, 18944),
    (6, 1024, 3584, 3584, 'int8', True): (1024, 512, 3584),
    (6, 1024, 3584, 8192, 'int8', True): (1024, 512, 8192),
    (6, 1024, 37888, 3584, 'int8', True): (1024, 512, 3584),
    (6, 1024, 4096, 14336, 'int8', True): (1024, 512, 14336),
    (6, 1024, 4096, 4096, 'int8', True): (1024, 512, 4096),
    (6, 1024, 4608, 3584, 'int8', True): (1024, 1536, 3584),
    (6, 1024, 5120, 1280, 'int8', True): (1024, 1024, 1280),
    (6, 1024, 5120, 3456, 'int8', True): (1024, 1280, 3456),
    (6, 1024, 5120, 640, 'int8', True): (256, 5120, 640),
    (6, 1024, 5120, 6912, 'int8', True): (1024, 512, 6912),
    (6, 1024, 6144, 4096, 'int8', True): (1024, 512, 4096),
    (6, 1024, 6912, 5120, 'int8', True): (1024, 2304, 2560),
    (6, 1024, 7168, 8192, 'int8', True): (1024, 512, 8192),
    (6, 1024, 8192, 1024, 'int8', True): (1024, 4096, 1024),
    (6, 1024, 8192, 3584, 'int8', True): (1024, 1024, 3584),
    (6, 1024, 896, 5120, 'int8', True): (1024, 896, 2560),
    (6, 128, 1024, 4096, 'int8', True): (128, 512, 4096),
    (6, 128, 1024, 8192, 'int8', True): (128, 256, 8192),
    (6, 128, 128, 8192, 'int8', True): (128, 128, 512),
    (6, 128, 1280, 8192, 'int8', True): (128, 256, 8192),
    (6, 128, 13824, 5120, 'int8', True): (128, 3456, 1024),
    (6, 128, 14336, 4096, 'int8', True): (128, 896, 4096),
    (6, 128, 1792, 5120, 'int8', True): (128, 1792, 1280),
    (6, 128, 28672, 4096, 'int8', True): (128, 1024, 4096),
    (6, 128, 3584, 18944, 'int8', True): (128, 512, 9472),
    (6, 128, 3584, 3584, 'int8', True): (128, 512, 3584),
    (6, 128, 3584, 8192, 'int8', True): (128, 896, 4096),
    (6, 128, 37888, 3584, 'int8', True): (128, 1024, 3584),
    (6, 128, 4096, 14336, 'int8', True): (128, 256, 14336),
    (6, 128, 4096, 4096, 'int8', True): (128, 512, 4096),
    (6, 128, 4608, 3584, 'int8', True): (128, 1152, 3584),
    (6, 128, 5120, 1280, 'int8', True): (128, 2560, 1280),
    (6, 128, 5120, 3456, 'int8', True): (128, 1024, 3456),
    (6, 128, 5120, 640, 'int8', True): (128, 2560, 640),
    (6, 128, 5120, 6912, 'int8', True): (128, 512, 6912),
    (6, 128, 6144, 4096, 'int8', True): (128, 768, 4096),
    (6, 128, 6912, 5120, 'int8', True): (128, 6912, 512),
    (6, 128, 7168, 8192, 'int8', True): (128, 1792, 2048),
    (6, 128, 8192, 1024, 'int8', True): (128, 2048, 1024),
    (6, 128, 8192, 3584, 'int8', True): (128, 1024, 3584),
    (6, 128, 896, 5120, 'int8', True): (128, 896, 2560),
    (6, 16, 1024, 4096, 'int8', True): (16, 512, 4096),
    (6, 16, 1024, 8192, 'int8', True): (16, 256, 8192),
    (6, 16, 128, 8192, 'int8', True): (16, 128, 4096),
    (6, 16, 1280, 8192, 'int8', True): (16, 256, 8192),
    (6, 16, 13824, 5120, 'int8', True): (16, 768, 5120),
    (6, 16, 14336, 4096, 'int8', True): (16, 1024, 4096),
    (6, 16, 1792, 5120, 'int8', True): (16, 1792, 1024),
    (6, 16, 28672, 4096, 'int8', True): (16, 4096, 1024),
    (6, 16, 3584, 18944, 'int8', True): (16, 256, 18944),
    (6, 16, 3584, 3584, 'int8', True): (16, 896, 3584),
    (6, 16, 3584, 8192, 'int8', True): (16, 512, 8192),
    (6, 16, 37888, 3584, 'int8', True): (16, 1024, 3584),
    (6, 16, 4096, 14336, 'int8', True): (16, 2048, 1792),
    (6, 16, 4096, 4096, 'int8', True): (16, 1024, 4096),
    (6, 16, 4608, 3584, 'int8', True): (16, 4608, 896),
    (6, 16, 5120, 1280, 'int8', True): (16, 2560, 1280),
    (6, 16, 5120, 3456, 'int8', True): (16, 1024, 3456),
    (6, 16, 5120, 640, 'int8', True): (16, 5120, 640),
    (6, 16, 5120, 6912, 'int8', True): (16, 512, 6912),
    (6, 16, 6144, 4096, 'int8', True): (16, 768, 4096),
    (6, 16, 6912, 5120, 'int8', True): (16, 6912, 512),
    (6, 16, 7168, 8192, 'int8', True): (16, 512, 8192),
    (6, 16, 8192, 1024, 'int8', True): (16, 2048, 1024),
    (6, 16, 8192, 3584, 'int8', True): (16, 4096, 896),
    (6, 16, 896, 5120, 'int8', True): (16, 896, 1280),
    (6, 16384, 1024, 4096, 'int8', True): (512, 1024, 4096),
    (6, 16384, 1024, 8192, 'int8', True): (512, 1024, 8192),
    (6, 16384, 128, 8192, 'int8', True): (1024, 128, 4096),
    (6, 16384, 1280, 8192, 'int8', True): (2048, 1280, 8192),
    (6, 16384, 13824, 5120, 'int8', True): (2048, 1536, 5120),
    (6, 16384, 14336, 4096, 'int8', True): (256, 3584, 4096),
    (6, 16384, 1792, 5120, 'int8', True): (512, 1792, 5120),
    (6, 16384, 28672, 4096, 'int8', True): (2048, 1792, 4096),
    (6, 16384, 3584, 18944, 'int8', True): (512, 1792, 4736),
    (6, 16384, 3584, 3584, 'int8', True): (256, 3584, 3584),
    (6, 16384, 3584, 8192, 'int8', True): (256, 3584, 8192),
    (6, 16384, 37888, 3584, 'int8', True): (4096, 512, 3584),
    (6, 16384, 4096, 14336, 'int8', True): (1024, 4096, 1024),
    (6, 16384, 4096, 4096, 'int8', True): (1024, 2048, 4096),
    (6, 16384, 4608, 3584, 'int8', True): (1024, 4608, 3584),
    (6, 16384, 5120, 1280, 'int8', True): (1024, 5120, 1280),
    (6, 16384, 5120, 3456, 'int8', True): (1024, 2560, 3456),
    (6, 16384, 5120, 640, 'int8', True): (1024, 5120, 640),
    (6, 16384, 5120, 6912, 'int8', True): (512, 5120, 6912),
    (6, 16384, 6144, 4096, 'int8', True): (1024, 6144, 4096),
    (6, 16384, 6912, 5120, 'int8', True): (1024, 2304, 5120),
    (6, 16384, 7168, 8192, 'int8', True): (256, 1792, 8192),
    (6, 16384, 8192, 1024, 'int8', True): (1024, 8192, 1024),
    (6, 16384, 8192, 3584, 'int8', True): (256, 8192, 3584),
    (6, 16384, 896, 5120, 'int8', True): (512, 896, 5120),
    (6, 2048, 1024, 4096, 'int8', True): (2048, 256, 4096),
    (6, 2048, 1024, 8192, 'int8', True): (2048, 256, 8192),
    (6, 2048, 128, 8192, 'int8', True): (512, 128, 8192),
    (6, 2048, 1280, 8192, 'int8', True): (512, 1280, 8192),
    (6, 2048, 13824, 5120, 'int8', True): (1024, 2304, 5120),
    (6, 2048, 14336, 4096, 'int8', True): (2048, 512, 4096),
    (6, 2048, 1792, 5120, 'int8', True): (2048, 256, 5120),
    (6, 2048, 28672, 4096, 'int8', True): (1024, 3584, 4096),
    (6, 2048, 3584, 18944, 'int8', True): (1024, 3584, 512),
    (6, 2048, 3584, 3584, 'int8', True): (1024, 512, 3584),
    (6, 2048, 3584, 8192, 'int8', True): (2048, 512, 8192),
    (6, 2048, 37888, 3584, 'int8', True): (1024, 1024, 3584),
    (6, 2048, 4096, 14336, 'int8', True): (2048, 4096, 512),
    (6, 2048, 4096, 4096, 'int8', True): (2048, 256, 4096),
    (6, 2048, 4608, 3584, 'int8', True): (2048, 512, 3584),
    (6, 2048, 5120, 1280, 'int8', True): (256, 5120, 1280),
    (6, 2048, 5120, 3456, 'int8', True): (2048, 256, 3456),
    (6, 2048, 5120, 640, 'int8', True): (256, 5120, 640),
    (6, 2048, 5120, 6912, 'int8', True): (2048, 512, 6912),
    (6, 2048, 6144, 4096, 'int8', True): (2048, 1024, 4096),
    (6, 2048, 6912, 5120, 'int8', True): (2048, 768, 5120),
    (6, 2048, 7168, 8192, 'int8', True): (2048, 512, 8192),
    (6, 2048, 8192, 1024, 'int8', True): (256, 8192, 1024),
    (6, 2048, 8192, 3584, 'int8', True): (2048, 512, 3584),
    (6, 2048, 896, 5120, 'int8', True): (1024, 896, 5120),
    (6, 256, 1024, 4096, 'int8', True): (256, 512, 4096),
    (6, 256, 1024, 8192, 'int8', True): (256, 256, 8192),
    (6, 256, 128, 8192, 'int8', True): (256, 128, 4096),
    (6, 256, 1280, 8192, 'int8', True): (256, 1280, 2048),
    (6, 256, 13824, 5120, 'int8', True): (256, 768, 5120),
    (6, 256, 14336, 4096, 'int8', True): (256, 896, 4096),
    (6, 256, 1792, 5120, 'int8', True): (256, 896, 5120),
    (6, 256, 28672, 4096, 'int8', True): (256, 3584, 2048),
    (6, 256, 3584, 18944, 'int8', True): (256, 512, 9472),
    (6, 256, 3584, 3584, 'int8', True): (256, 896, 3584),
    (6, 256, 3584, 8192, 'int8', True): (256, 1792, 2048),
    (6, 256, 37888, 3584, 'int8', True): (256, 1024, 3584),
    (6, 256, 4096, 14336, 'int8', True): (256, 256, 14336),
    (6, 256, 4096, 4096, 'int8', True): (256, 4096, 1024),
    (6, 256, 4608, 3584, 'int8', True): (256, 768, 3584),
    (6, 256, 5120, 1280, 'int8', True): (256, 2560, 1280),
    (6, 256, 5120, 3456, 'int8', True): (256, 1280, 3456),
    (6, 256, 5120, 640, 'int8', True): (256, 2560, 640),
    (6, 256, 5120, 6912, 'int8', True): (256, 512, 6912),
    (6, 256, 6144, 4096, 'int8', True): (256, 1024, 4096),
    (6, 256, 6912, 5120, 'int8', True): (256, 3456, 1024),
    (6, 256, 7168, 8192, 'int8', True): (256, 896, 8192),
    (6, 256, 8192, 1024, 'int8', True): (256, 4096, 1024),
    (6, 256, 8192, 3584, 'int8', True): (256, 1024, 3584),
    (6, 256, 896, 5120, 'int8', True): (256, 896, 2560),
    (6, 32, 1024, 4096, 'int8', True): (32, 512, 4096),
    (6, 32, 1024, 8192, 'int8', True): (32, 256, 8192),
    (6, 32, 128, 8192, 'int8', True): (32, 128, 1024),
    (6, 32, 1280, 8192, 'int8', True): (32, 1280, 2048),
    (6, 32, 13824, 5120, 'int8', True): (32, 768, 5120),
    (6, 32, 14336, 4096, 'int8', True): (32, 896, 4096),
    (6, 32, 1792, 5120, 'int8', True): (32, 1792, 1280),
    (6, 32, 28672, 4096, 'int8', True): (32, 2048, 4096),
    (6, 32, 3584, 18944, 'int8', True): (32, 512, 18944),
    (6, 32, 3584, 3584, 'int8', True): (32, 3584, 896),
    (6, 32, 3584, 8192, 'int8', True): (32, 512, 8192),
    (6, 32, 37888, 3584, 'int8', True): (32, 1024, 3584),
    (6, 32, 4096, 14336, 'int8', True): (32, 256, 14336),
    (6, 32, 4096, 4096, 'int8', True): (32, 4096, 1024),
    (6, 32, 4608, 3584, 'int8', True): (32, 768, 3584),
    (6, 32, 5120, 1280, 'int8', True): (32, 2560, 1280),
    (6, 32, 5120, 3456, 'int8', True): (32, 1024, 3456),
    (6, 32, 5120, 640, 'int8', True): (32, 2560, 640),
    (6, 32, 5120, 6912, 'int8', True): (32, 512, 6912),
    (6, 32, 6144, 4096, 'int8', True): (32, 3072, 1024),
    (6, 32, 6912, 5120, 'int8', True): (32, 6912, 512),
    (6, 32, 7168, 8192, 'int8', True): (32, 7168, 1024),
    (6, 32, 8192, 1024, 'int8', True): (32, 2048, 1024),
    (6, 32, 8192, 3584, 'int8', True): (32, 1024, 3584),
    (6, 32, 896, 5120, 'int8', True): (32, 896, 2560),
    (6, 4096, 1024, 4096, 'int8', True): (4096, 256, 4096),
    (6, 4096, 1024, 8192, 'int8', True): (1024, 1024, 8192),
    (6, 4096, 128, 8192, 'int8', True): (2048, 128, 8192),
    (6, 4096, 1280, 8192, 'int8', True): (1024, 1280, 8192),
    (6, 4096, 13824, 5120, 'int8', True): (2048, 1536, 5120),
    (6, 4096, 14336, 4096, 'int8', True): (4096, 512, 4096),
    (6, 4096, 1792, 5120, 'int8', True): (2048, 256, 5120),
    (6, 4096, 28672, 4096, 'int8', True): (2048, 1792, 4096),
    (6, 4096, 3584, 18944, 'int8', True): (1024, 3584, 512),
    (6, 4096, 3584, 3584, 'int8', True): (4096, 512, 3584),
    (6, 4096, 3584, 8192, 'int8', True): (1024, 1792, 8192),
    (6, 4096, 37888, 3584, 'int8', True): (4096, 1024, 3584),
    (6, 4096, 4096, 14336, 'int8', True): (1024, 4096, 1792),
    (6, 4096, 4096, 4096, 'int8', True): (4096, 256, 4096),
    (6, 4096, 4608, 3584, 'int8', True): (4096, 512, 3584),
    (6, 4096, 5120, 1280, 'int8', True): (256, 5120, 1280),
    (6, 4096, 5120, 3456, 'int8', True): (4096, 256, 3456),
    (6, 4096, 5120, 640, 'int8', True): (512, 5120, 640),
    (6, 4096, 5120, 6912, 'int8', True): (512, 5120, 6912),
    (6, 4096, 6144, 4096, 'int8', True): (4096, 512, 4096),
    (6, 4096, 6912, 5120, 'int8', True): (1024, 2304, 5120),
    (6, 4096, 7168, 8192, 'int8', True): (1024, 1024, 8192),
    (6, 4096, 8192, 1024, 'int8', True): (512, 8192, 1024),
    (6, 4096, 8192, 3584, 'int8', True): (4096, 512, 3584),
    (6, 4096, 896, 5120, 'int8', True): (512, 896, 5120),
    (6, 512, 1024, 4096, 'int8', True): (512, 1024, 2048),
    (6, 512, 1024, 8192, 'int8', True): (512, 1024, 2048),
    (6, 512, 128, 8192, 'int8', True): (512, 128, 4096),
    (6, 512, 1280, 8192, 'int8', True): (512, 1280, 2048),
    (6, 512, 13824, 5120, 'int8', True): (512, 768, 5120),
    (6, 512, 14336, 4096, 'int8', True): (512, 1792, 4096),
    (6, 512, 1792, 5120, 'int8', True): (512, 1792, 1280),
    (6, 512, 28672, 4096, 'int8', True): (512, 1792, 4096),
    (6, 512, 3584, 18944, 'int8', True): (512, 256, 18944),
    (6, 512, 3584, 3584, 'int8', True): (512, 3584, 896),
    (6, 512, 3584, 8192, 'int8', True): (512, 3584, 2048),
    (6, 512, 37888, 3584, 'int8', True): (512, 1024, 3584),
    (6, 512, 4096, 14336, 'int8', True): (512, 4096, 1792),
    (6, 512, 4096, 4096, 'int8', True): (512, 512, 4096),
    (6, 512, 4608, 3584, 'int8', True): (512, 1152, 3584),
    (6, 512, 5120, 1280, 'int8', True): (512, 1280, 1280),
    (6, 512, 5120, 3456, 'int8', True): (512, 1024, 3456),
    (6, 512, 5120, 640, 'int8', True): (512, 2560, 640),
    (6, 512, 5120, 6912, 'int8', True): (512, 1280, 6912),
    (6, 512, 6144, 4096, 'int8', True): (512, 512, 4096),
    (6, 512, 6912, 5120, 'int8', True): (512, 1152, 5120),
    (6, 512, 7168, 8192, 'int8', True): (512, 512, 8192),
    (6, 512, 8192, 1024, 'int8', True): (512, 4096, 1024),
    (6, 512, 8192, 3584, 'int8', True): (512, 1024, 3584),
    (6, 512, 896, 5120, 'int8', True): (512, 896, 1280),
    (6, 64, 1024, 4096, 'int8', True): (64, 512, 4096),
    (6, 64, 1024, 8192, 'int8', True): (64, 256, 8192),
    (6, 64, 128, 8192, 'int8', True): (64, 128, 8192),
    (6, 64, 1280, 8192, 'int8', True): (64, 1280, 2048),
    (6, 64, 13824, 5120, 'int8', True): (64, 13824, 256),
    (6, 64, 14336, 4096, 'int8', True): (64, 1024, 4096),
    (6, 64, 1792, 5120, 'int8', True): (64, 1792, 1280),
    (6, 64, 28672, 4096, 'int8', True): (64, 896, 4096),
    (6, 64, 3584, 18944, 'int8', True): (64, 256, 18944),
    (6, 64, 3584, 3584, 'int8', True): (64, 896, 3584),
    (6, 64, 3584, 8192, 'int8', True): (64, 512, 8192),
    (6, 64, 37888, 3584, 'int8', True): (64, 1024, 3584),
    (6, 64, 4096, 14336, 'int8', True): (64, 4096, 1024),
    (6, 64, 4096, 4096, 'int8', True): (64, 4096, 1024),
    (6, 64, 4608, 3584, 'int8', True): (64, 768, 3584),
    (6, 64, 5120, 1280, 'int8', True): (64, 2560, 1280),
    (6, 64, 5120, 3456, 'int8', True): (64, 1024, 3456),
    (6, 64, 5120, 640, 'int8', True): (64, 2560, 640),
    (6, 64, 5120, 6912, 'int8', True): (64, 5120, 768),
    (6, 64, 6144, 4096, 'int8', True): (64, 1024, 4096),
    (6, 64, 6912, 5120, 'int8', True): (64, 3456, 1280),
    (6, 64, 7168, 8192, 'int8', True): (64, 512, 8192),
    (6, 64, 8192, 1024, 'int8', True): (64, 2048, 1024),
    (6, 64, 8192, 3584, 'int8', True): (64, 4096, 896),
    (6, 64, 896, 5120, 'int8', True): (64, 896, 1280),
    (6, 8192, 1024, 4096, 'int8', True): (2048, 1024, 4096),
    (6, 8192, 1024, 8192, 'int8', True): (256, 1024, 8192),
    (6, 8192, 128, 8192, 'int8', True): (4096, 128, 1024),
    (6, 8192, 1280, 8192, 'int8', True): (1024, 1280, 8192),
    (6, 8192, 13824, 5120, 'int8', True): (2048, 1536, 5120),
    (6, 8192, 14336, 4096, 'int8', True): (2048, 1792, 4096),
    (6, 8192, 1792, 5120, 'int8', True): (1024, 1792, 5120),
    (6, 8192, 28672, 4096, 'int8', True): (2048, 1792, 4096),
    (6, 8192, 3584, 18944, 'int8', True): (1024, 3584, 512),
    (6, 8192, 3584, 3584, 'int8', True): (2048, 3584, 3584),
    (6, 8192, 3584, 8192, 'int8', True): (1024, 3584, 8192),
    (6, 8192, 37888, 3584, 'int8', True): (4096, 512, 3584),
    (6, 8192, 4096, 14336, 'int8', True): (1024, 2048, 3584),
    (6, 8192, 4096, 4096, 'int8', True): (1024, 4096, 4096),
    (6, 8192, 4608, 3584, 'int8', True): (2048, 1536, 3584),
    (6, 8192, 5120, 1280, 'int8', True): (256, 5120, 1280),
    (6, 8192, 5120, 3456, 'int8', True): (1024, 5120, 3456),
    (6, 8192, 5120, 640, 'int8', True): (1024, 5120, 640),
    (6, 8192, 5120, 6912, 'int8', True): (256, 5120, 6912),
    (6, 8192, 6144, 4096, 'int8', True): (1024, 2048, 4096),
    (6, 8192, 6912, 5120, 'int8', True): (512, 6912, 5120),
    (6, 8192, 7168, 8192, 'int8', True): (256, 1792, 8192),
    (6, 8192, 8192, 1024, 'int8', True): (256, 8192, 1024),
    (6, 8192, 8192, 3584, 'int8', True): (2048, 2048, 3584),
    (6, 8192, 896, 5120, 'int8', True): (2048, 896, 2560),
    (7, 1024, 14336, 4096, 'float8_e4m3fn', True): (512, 7168, 1024),
    (7, 1024, 25600, 5120, 'float8_e4m3fn', True): (1024, 2560, 1024),
    (7, 1024, 28672, 8192, 'float8_e4m3fn', True): (1024, 3584, 1024),
    (7, 1024, 3072, 4096, 'float8_e4m3fn', True): (1024, 3072, 512),
    (7, 1024, 4096, 2048, 'float8_e4m3fn', True): (1024, 4096, 512),
    (7, 1024, 4096, 7168, 'float8_e4m3fn', True): (1024, 4096, 512),
    (7, 1024, 5120, 12800, 'float8_e4m3fn', True): (512, 5120, 512),
    (7, 1024, 5120, 4096, 'float8_e4m3fn', True): (1024, 2560, 1024),
    (7, 1024, 5120, 5120, 'float8_e4m3fn', True): (512, 5120, 1024),
    (7, 1024, 5120, 8192, 'float8_e4m3fn', True): (512, 5120, 1024),
    (7, 1024, 8192, 14336, 'float8_e4m3fn', True): (1024, 4096, 1024),
    (7, 1024, 8192, 4096, 'float8_e4m3fn', True): (1024, 4096, 1024),
    (7, 128, 14336, 4096, 'float8_e4m3fn', True): (128, 14336, 1024),
    (7, 128, 25600, 5120, 'float8_e4m3fn', True): (128, 3200, 5120),
    (7, 128, 28672, 8192, 'float8_e4m3fn', True): (128, 14336, 1024),
    (7, 128, 3072, 4096, 'float8_e4m3fn', True): (128, 1536, 4096),
    (7, 128, 4096, 2048, 'float8_e4m3fn', True): (128, 2048, 2048),
    (7, 128, 4096, 7168, 'float8_e4m3fn', True): (128, 1024, 7168),
    (7, 128, 5120, 12800, 'float8_e4m3fn', True): (128, 1280, 12800),
    (7, 128, 5120, 4096, 'float8_e4m3fn', True): (128, 5120, 1024),
    (7, 128, 5120, 5120, 'float8_e4m3fn', True): (128, 5120, 1280),
    (7, 128, 5120, 8192, 'float8_e4m3fn', True): (128, 5120, 2048),
    (7, 128, 8192, 14336, 'float8_e4m3fn', True): (128, 1024, 14336),
    (7, 128, 8192, 4096, 'float8_e4m3fn', True): (128, 4096, 2048),
    (7, 16, 14336, 4096, 'float8_e4m3fn', True): (16, 3584, 4096),
    (7, 16, 25600, 5120, 'float8_e4m3fn', True): (16, 3200, 5120),
    (7, 16, 28672, 8192, 'float8_e4m3fn', True): (16, 1792, 8192),
    (7, 16, 3072, 4096, 'float8_e4m3fn', True): (16, 1536, 4096),
    (7, 16, 4096, 2048, 'float8_e4m3fn', True): (16, 2048, 2048),
    (7, 16, 4096, 7168, 'float8_e4m3fn', True): (16, 1024, 7168),
    (7, 16, 5120, 12800, 'float8_e4m3fn', True): (16, 1280, 12800),
    (7, 16, 5120, 4096, 'float8_e4m3fn', True): (16, 1280, 4096),
    (7, 16, 5120, 5120, 'float8_e4m3fn', True): (16, 1280, 5120),
    (7, 16, 5120, 8192, 'float8_e4m3fn', True): (16, 1280, 8192),
    (7, 16, 8192, 14336, 'float8_e4m3fn', True): (16, 1024, 14336),
    (7, 16, 8192, 4096, 'float8_e4m3fn', True): (16, 2048, 4096),
    (7, 2048, 14336, 4096, 'float8_e4m3fn', True): (512, 7168, 1024),
    (7, 2048, 25600, 5120, 'float8_e4m3fn', True): (512, 6400, 1024),
    (7, 2048, 28672, 8192, 'float8_e4m3fn', True): (1024, 3584, 1024),
    (7, 2048, 3072, 4096, 'float8_e4m3fn', True): (1024, 3072, 1024),
    (7, 2048, 4096, 2048, 'float8_e4m3fn', True): (256, 4096, 2048),
    (7, 2048, 4096, 7168, 'float8_e4m3fn', True): (1024, 4096, 512),
    (7, 2048, 5120, 12800, 'float8_e4m3fn', True): (1024, 2560, 512),
    (7, 2048, 5120, 4096, 'float8_e4m3fn', True): (512, 5120, 1024),
    (7, 2048, 5120, 5120, 'float8_e4m3fn', True): (512, 5120, 1024),
    (7, 2048, 5120, 8192, 'float8_e4m3fn', True): (1024, 2560, 1024),
    (7, 2048, 8192, 14336, 'float8_e4m3fn', True): (512, 8192, 512),
    (7, 2048, 8192, 4096, 'float8_e4m3fn', True): (1024, 4096, 512),
    (7, 256, 14336, 4096, 'float8_e4m3fn', True): (256, 14336, 512),
    (7, 256, 25600, 5120, 'float8_e4m3fn', True): (256, 6400, 1024),
    (7, 256, 28672, 8192, 'float8_e4m3fn', True): (256, 7168, 1024),
    (7, 256, 3072, 4096, 'float8_e4m3fn', True): (256, 3072, 1024),
    (7, 256, 4096, 2048, 'float8_e4m3fn', True): (256, 4096, 1024),
    (7, 256, 4096, 7168, 'float8_e4m3fn', True): (256, 4096, 1024),
    (7, 256, 5120, 12800, 'float8_e4m3fn', True): (256, 2560, 2560),
    (7, 256, 5120, 4096, 'float8_e4m3fn', True): (256, 2560, 2048),
    (7, 256, 5120, 5120, 'float8_e4m3fn', True): (256, 5120, 1024),
    (7, 256, 5120, 8192, 'float8_e4m3fn', True): (256, 5120, 1024),
    (7, 256, 8192, 14336, 'float8_e4m3fn', True): (256, 8192, 1792),
    (7, 256, 8192, 4096, 'float8_e4m3fn', True): (256, 8192, 1024),
    (7, 32, 14336, 4096, 'float8_e4m3fn', True): (32, 3584, 4096),
    (7, 32, 25600, 5120, 'float8_e4m3fn', True): (32, 2560, 5120),
    (7, 32, 28672, 8192, 'float8_e4m3fn', True): (32, 2048, 8192),
    (7, 32, 3072, 4096, 'float8_e4m3fn', True): (32, 1536, 4096),
    (7, 32, 4096, 2048, 'float8_e4m3fn', True): (32, 4096, 1024),
    (7, 32, 4096, 7168, 'float8_e4m3fn', True): (32, 1024, 7168),
    (7, 32, 5120, 12800, 'float8_e4m3fn', True): (32, 1280, 12800),
    (7, 32, 5120, 4096, 'float8_e4m3fn', True): (32, 1280, 4096),
    (7, 32, 5120, 5120, 'float8_e4m3fn', True): (32, 2560, 2560),
    (7, 32, 5120, 8192, 'float8_e4m3fn', True): (32, 1280, 8192),
    (7, 32, 8192, 14336, 'float8_e4m3fn', True): (32, 1024, 14336),
    (7, 32, 8192, 4096, 'float8_e4m3fn', True): (32, 8192, 1024),
    (7, 4096, 14336, 4096, 'float8_e4m3fn', True): (1024, 3584, 1024),
    (7, 4096, 25600, 5120, 'float8_e4m3fn', True): (512, 6400, 1024),
    (7, 4096, 28672, 8192, 'float8_e4m3fn', True): (1024, 3584, 1024),
    (7, 4096, 3072, 4096, 'float8_e4m3fn', True): (1024, 3072, 1024),
    (7, 4096, 4096, 2048, 'float8_e4m3fn', True): (1024, 4096, 512),
    (7, 4096, 4096, 7168, 'float8_e4m3fn', True): (2048, 2048, 512),
    (7, 4096, 5120, 12800, 'float8_e4m3fn', True): (1024, 2560, 512),
    (7, 4096, 5120, 4096, 'float8_e4m3fn', True): (2048, 1280, 1024),
    (7, 4096, 5120, 5120, 'float8_e4m3fn', True): (512, 5120, 1024),
    (7, 4096, 5120, 8192, 'float8_e4m3fn', True): (1024, 2560, 1024),
    (7, 4096, 8192, 14336, 'float8_e4m3fn', True): (1024, 4096, 1024),
    (7, 4096, 8192, 4096, 'float8_e4m3fn', True): (1024, 4096, 1024),
    (7, 512, 14336, 4096, 'float8_e4m3fn', True): (512, 7168, 1024),
    (7, 512, 25600, 5120, 'float8_e4m3fn', True): (512, 6400, 1024),
    (7, 512, 28672, 8192, 'float8_e4m3fn', True): (512, 7168, 1024),
    (7, 512, 3072, 4096, 'float8_e4m3fn', True): (512, 3072, 1024),
    (7, 512, 4096, 2048, 'float8_e4m3fn', True): (512, 4096, 1024),
    (7, 512, 4096, 7168, 'float8_e4m3fn', True): (512, 4096, 512),
    (7, 512, 5120, 12800, 'float8_e4m3fn', True): (512, 5120, 512),
    (7, 512, 5120, 4096, 'float8_e4m3fn', True): (512, 5120, 1024),
    (7, 512, 5120, 5120, 'float8_e4m3fn', True): (512, 2560, 1024),
    (7, 512, 5120, 8192, 'float8_e4m3fn', True): (512, 5120, 1024),
    (7, 512, 8192, 14336, 'float8_e4m3fn', True): (512, 8192, 512),
    (7, 512, 8192, 4096, 'float8_e4m3fn', True): (256, 8192, 1024),
    (7, 64, 14336, 4096, 'float8_e4m3fn', True): (64, 3584, 4096),
    (7, 64, 25600, 5120, 'float8_e4m3fn', True): (64, 2560, 5120),
    (7, 64, 28672, 8192, 'float8_e4m3fn', True): (64, 28672, 512),
    (7, 64, 3072, 4096, 'float8_e4m3fn', True): (64, 3072, 2048),
    (7, 64, 4096, 2048, 'float8_e4m3fn', True): (64, 4096, 1024),
    (7, 64, 4096, 7168, 'float8_e4m3fn', True): (64, 1024, 7168),
    (7, 64, 5120, 12800, 'float8_e4m3fn', True): (64, 1024, 12800),
    (7, 64, 5120, 4096, 'float8_e4m3fn', True): (64, 1280, 4096),
    (7, 64, 5120, 5120, 'float8_e4m3fn', True): (64, 1280, 5120),
    (7, 64, 5120, 8192, 'float8_e4m3fn', True): (64, 1280, 8192),
    (7, 64, 8192, 14336, 'float8_e4m3fn', True): (64, 1024, 14336),
    (7, 64, 8192, 4096, 'float8_e4m3fn', True): (64, 8192, 1024),
    (7, 8192, 14336, 4096, 'float8_e4m3fn', True): (1024, 3584, 1024),
    (7, 8192, 28672, 8192, 'float8_e4m3fn', True): (1024, 3584, 1024),
    (7, 8192, 3072, 4096, 'float8_e4m3fn', True): (1024, 3072, 1024),
    (7, 8192, 4096, 2048, 'float8_e4m3fn', True): (1024, 4096, 1024),
    (7, 8192, 4096, 7168, 'float8_e4m3fn', True): (1024, 4096, 512),
    (7, 8192, 5120, 8192, 'float8_e4m3fn', True): (1024, 2560, 512),
    (7, 8192, 8192, 14336, 'float8_e4m3fn', True): (1024, 4096, 1024),
    (7, 8192, 8192, 4096, 'float8_e4m3fn', True): (1024, 4096, 1024),
    # go/keep-sorted end
}

DEVICE_VMEM_LIMIT = {6: 96 * 1024 * 1024, 7: 48 * 1024 * 1024}


def get_device_vmem_limit() -> int:
    tpu_version = get_tpu_version()
    if tpu_version not in DEVICE_VMEM_LIMIT:
        logger.warning_once(
            'VMEM limit for TPU version %d not found. Using default VMEM limit '
            'of 96MiB', tpu_version)
        return 96 * 1024 * 1024
    return DEVICE_VMEM_LIMIT[tpu_version]


def get_tpu_version() -> int:
    """Returns the numeric version of the TPU, or -1 if not on TPU."""
    kind = jax.devices()[0].device_kind
    match = re.match(r'^TPU[^\d]*(\d+)', kind)
    if match is None:
        return -1
    return int(match.group(1))


def get_key(
    batch_size,
    n_output_features,
    n_input_features,
    activation_dtype,
    quantize_activation,
):
    """Returns the key for the given parameters."""
    return (
        get_tpu_version(),
        batch_size,
        n_output_features,
        n_input_features,
        activation_dtype,
        quantize_activation,
    )


def get_tuned_block_sizes(
    batch_size,
    n_output_features,
    n_input_features,
    weight_dtype,
    quantize_activation,
):
    """Retrieve the tuned block sizes for the given parameters.

  Args:
      batch_size (int): The batch size.
      n_output_features (int): The number of output features.
      n_input_features (int): The number of input features.
      weight_dtype (str): The data type of the activation ('int8' or
        'float8_e4m3fn').
      quantize_activation (bool): Whether to quantize the activation.

  Returns:
      tuple: A tuple containing the batch_block_size, out_block_size, and
      in_block_size.
  """
    key = get_key(
        batch_size,
        n_output_features,
        n_input_features,
        weight_dtype,
        quantize_activation,
    )
    tuned_sizes = TUNED_BLOCK_SIZES.get(key)
    if tuned_sizes is None:
        logger.warning_once(
            'Couldn`t find tuned sizes for the quantized matmul kernel with %s',
            key)
        return (128, 128, 128)
    else:
        return tuned_sizes
