x-run-condition: &run-on-nightly-or-tag
  if: build.env("NIGHTLY") == "1" || build.tag =~ /^v?[0-9]+(\.[a-zA-Z0-9]+)*([a-zA-Z]+[0-9]*)?$/

steps:
   - label: "Upload Tests for Models & Features"
     <<: *run-on-nightly-or-tag
     agents:
       # TODO : can be done on non-TPU queues once they're set up b/449203039
       queue: tpu_v6e_queue
     commands:
       - bash .buildkite/scripts/upload_models_and_features.sh

   - wait: ~
     continue_on_failure: true  # ensure we still generate support matrices even if some tests fail

   - label: "Generate support matrices"
     <<: *run-on-nightly-or-tag
     key: generate_support_matrices
     agents:
       queue: tpu_v6e_queue
     soft_fail: true
     commands:
       - bash .buildkite/scripts/generate_support_matrices.sh

   - label: "Commit support matrices if is nightly build or release tag specified"
     <<: *run-on-nightly-or-tag
     key: commit_support_matrices
     depends_on: generate_support_matrices
     agents:
       queue: tpu_v6e_queue
     secrets:
      - GITHUB_PAT
     command:
       - |
         source .buildkite/scripts/export_commit_message.sh
         bash .buildkite/scripts/commit_push.sh .buildkite/scripts/git_add_support_matrices.sh
